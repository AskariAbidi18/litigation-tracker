<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Case – Aeka Litigation Tracker</title>
  <style>
    /* Common Font Import */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    /* Theme Variables: Red, Shades of Red, and White */
    :root {
      /* Base Palette for Red Theme */
      --logo-primary-red: #8C1C1C;
      --logo-primary-red-darker: #6E1616;
      --logo-primary-red-darkest: #4B1212;
      
      --logo-red-tint-light: #F5E8E8;    
      --logo-red-tint-medium: #D9C3C3;   
      --logo-text-muted-red: #8C5555;
      
      --neutral-white: #FFFFFF;
      --neutral-almost-white: #FCFBFB;

      /* UI Specific Variables */
      --page-bg: var(--neutral-almost-white);
      --form-container-bg: var(--neutral-white);
      --main-text-color: var(--logo-primary-red-darkest);
      --heading-color: var(--logo-primary-red);
      --label-color: var(--logo-primary-red-darker);
      
      --input-bg: var(--neutral-white);
      --input-text-color: var(--logo-primary-red-darkest);
      --input-border: var(--logo-red-tint-medium);
      --input-focus-border: var(--logo-primary-red);
      --input-focus-bg: var(--logo-red-tint-light);
      --input-focus-shadow-color: rgba(140, 28, 28, 0.25);

      --button-bg: var(--logo-primary-red);
      --button-hover-bg: var(--logo-primary-red-darker);
      --button-text-color: var(--neutral-white);
      
      /* Structural Variables */
      --border-radius-lg: 12px; 
      --border-radius-md: 8px;  
      --border-radius-sm: 6px;  
      --shadow-color: rgba(140, 28, 28, 0.1); 
      --font-family: 'Inter', Arial, sans-serif;

      /* Accordion Specific Variables */
      --accordion-header-bg: var(--logo-red-tint-light);
      --accordion-header-hover-bg: #EADCDC; 
      --accordion-header-text-color: var(--logo-primary-red-darker);
      --accordion-content-border-color: var(--logo-red-tint-medium);
      --accordion-icon-color: var(--logo-primary-red-darker);
    }

    /* Global Body Styles */
    body {
      font-family: var(--font-family);
      margin: 0; 
      padding: 25px 20px; 
      background: var(--page-bg); 
      color: var(--main-text-color);     
      min-height: 100vh; 
      box-sizing: border-box;
    }

    /* Watermark Styling */
    body::after {
        content: "";
        /* Updated image path */
        background-image: url('images/WebsiteLogo_1-898735755-1659284008389.webp'); 
        background-repeat: no-repeat;
        background-position: center center;
        background-size: 250px auto; 
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 250px; 
        height: 250px;
        opacity: 0.03; 
        z-index: -1000; 
        pointer-events: none;
    }

     /* Header Bar for User Info & Logout */
     .header-bar {
        background-color: var(--logo-red-tint-light);
        padding: 10px 25px;
        margin: -25px -20px 20px -20px; 
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px var(--shadow-color);
        position: sticky; 
        top: 0;
        z-index: 100; 
    }
    .header-bar .app-title-link {
        text-decoration: none;
        color: var(--heading-color);
        font-weight: 700;
        font-size: 1.2rem;
    }
    .header-bar .user-info-display {
        font-size: 0.9rem;
        color: var(--main-text-color);
    }
    .header-bar .user-info-display span {
        font-weight: 600;
    }
    .header-bar #logout-button-header {
        background-color: var(--button-bg);
        color: var(--button-text-color);
        border: none;
        padding: 8px 15px;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: background-color 0.3s ease;
    }
    .header-bar #logout-button-header:hover {
        background-color: var(--button-hover-bg);
    }

    /* Main Heading */
    h1 {
      text-align: center;
      color: var(--heading-color); 
      margin-top: 10px; 
      margin-bottom: 30px;
      font-size: 2.2rem;
      font-weight: 700;
    }

    /* Form Styling */
    form {
      max-width: 800px;
      margin: 0 auto 30px auto; 
      background-color: var(--form-container-bg); 
      padding: 25px 35px;      
      border-radius: var(--border-radius-lg);       
      box-shadow: 0 6px 20px var(--shadow-color); 
      position: relative; 
      z-index: 1; 
    }

    /* Accordion Styling */
    .accordion-section {
        margin-bottom: 15px;
        border: 1px solid var(--accordion-content-border-color);
        border-radius: var(--border-radius-md);
        overflow: hidden; 
    }
    .accordion-header {
        background-color: var(--accordion-header-bg);
        color: var(--accordion-header-text-color);
        cursor: pointer;
        padding: 15px 20px;
        width: 100%;
        text-align: left;
        border: none;
        outline: none;
        font-size: 1.1rem;
        font-weight: 700;
        font-family: var(--font-family);
        transition: background-color 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .accordion-header:hover {
        background-color: var(--accordion-header-hover-bg);
    }
    .accordion-header.active {
      border-bottom: 1px solid var(--accordion-content-border-color);
    }
    .accordion-icon {
        font-size: 1.2em;
        font-weight: bold;
        color: var(--accordion-icon-color);
        transition: transform 0.3s ease;
    }
    .accordion-header.active .accordion-icon {
        transform: rotate(45deg); 
    }
    .accordion-content {
        padding: 0 25px 20px 25px; 
        background-color: var(--neutral-white);
        display: none; 
        overflow: hidden;
    }
    .accordion-content.active {
        display: block;
    }

    /* Label Styling */
    label {
      display: block;
      margin-top: 18px; 
      margin-bottom: 6px; 
      color: var(--label-color);   
      font-size: 0.9rem; 
      font-weight: 600; 
    }
     label span.required-asterisk {
        color: var(--logo-primary-red);
        font-weight: bold;
        margin-left: 2px;
    }

    /* Input and Select Styling */
    input[type="text"],
    input[type="date"],
    input[type="number"],
    select {
      width: 100%;
      padding: 11px 14px; 
      font-size: 0.95rem; 
      font-family: var(--font-family);
      margin-top: 4px; 
      border: 1.5px solid var(--input-border);   
      border-radius: var(--border-radius-sm);
      background-color: var(--input-bg);
      color: var(--input-text-color);
      box-sizing: border-box; 
      transition: border-color 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
    }
    input::placeholder {
        color: var(--logo-text-muted-red);
        opacity: 0.8;
    }
    select[multiple] {
        height: 120px; 
        padding: 10px;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: var(--input-focus-border);      
      background-color: var(--input-focus-bg);
      outline: none; 
      box-shadow: 0 0 0 3px var(--input-focus-shadow-color);
    }

    select:not([multiple]) {
        appearance: none; 
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234B1212%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 0.8em auto;
        padding-right: 2.5rem; 
    }

    /* Submit Button Styling */
    button[type="submit"] {
      display: block; 
      margin: 35px auto 15px auto; 
      padding: 12px 30px; 
      font-size: 1.05rem; 
      font-family: var(--font-family);
      font-weight: 700;
      background-color: var(--button-bg); 
      color: var(--button-text-color);
      border: none;
      border-radius: var(--border-radius-md);
      cursor: pointer;
      box-shadow: 0 5px 10px rgba(140, 28, 28, 0.2);
      transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
    }
    button[type="submit"]:hover {
      background-color: var(--button-hover-bg); 
      box-shadow: 0 7px 14px rgba(110, 22, 22, 0.3);
      transform: translateY(-2px);
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        h1 { font-size: 1.9rem; }
        form { padding: 20px 25px; }
        .accordion-header { font-size: 1rem; padding: 12px 15px; }
        .accordion-content { padding: 0 15px 15px 15px; }
    }
     @media (max-width: 600px) {
        body { padding: 15px; }
        .header-bar { margin: -15px -15px 15px -15px; padding: 8px 15px;}
        .header-bar .app-title-link { font-size: 1rem; }
        .header-bar .user-info-display { font-size: 0.8rem; }
        .header-bar #logout-button-header { padding: 6px 10px; font-size: 0.8rem;}

        h1 { font-size: 1.7rem; margin-bottom: 20px;}
        form { padding: 20px 20px; }
        label { font-size: 0.85rem; margin-top: 15px; }
        input[type="text"], input[type="date"], input[type="number"], select {
            padding: 10px 12px;
            font-size: 0.9rem;
        }
        button[type="submit"] {
            font-size: 1rem;
            padding: 12px 20px;
            margin-top: 30px;
        }
     }
  </style>
</head>
<body>
  <div class="header-bar">
    <a href="task-overview.html" class="app-title-link">Aeka Litigation Tracker</a>
    <div class="user-info-display">
        Logged in as: <span id="user-email-role-display">Loading...</span>
    </div>
    <button id="logout-button-header">Logout</button>
  </div>

  <h1>Edit Case</h1>
  <form id="editForm">
    <div class="accordion-section">
      <button type="button" class="accordion-header active">Client & Case Details <span class="accordion-icon">−</span></button>
      <div class="accordion-content active" style="display: block;">
        <label for="client">Client:</label> <input type="text" id="client" placeholder="Client Name" />
        <label for="state">State:</label> <input type="text" id="state" placeholder="State"/>
        
        <label for="primaryLeadNameDisplay">Primary Lead:</label> 
        <input type="text" id="primaryLeadNameDisplay" readonly /> 
        <label for="assignedTeammates">Assigned Teammates (Co-Leads):</label>
        <select id="assignedTeammates" multiple></select>
        <small style="display: block; margin-top: 4px; color: var(--muted-text-color);">Hold Ctrl (or Cmd on Mac) to select multiple teammates.</small>

        <label for="currentStage">Current Stage:</label> <input type="text" id="currentStage" placeholder="e.g., Notice Received"/>
        <label for="nextStep">Next Step:</label> <input type="text" id="nextStep" placeholder="e.g., Prepare Reply"/>
        <label for="issue">Issue (Primary):</label> <input type="text" id="issue" placeholder="Main issue of the case"/>
        
        <label for="status">Status:</label>
        <select id="status">
          <option value="">Select Status</option>
          <option value="Open">Open</option>
          <option value="Pending">Pending</option>
          <option value="Closed">Closed</option>
        </select>

        <label for="priority">Priority:</label>
        <select id="priority">
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
        </select>

        <label for="period">Period:</label> <input type="text" id="period" placeholder="e.g., FY 2023-24"/>
        <label for="caseId">Case ID (Internal):</label> <input type="text" id="caseId" placeholder="Your internal case ID"/>
      </div>
    </div>

    <div class="accordion-section">
      <button type="button" class="accordion-header">ADT Details <span class="accordion-icon">+</span></button>
      <div class="accordion-content">
        <label for="adt01ReferenceId">ADT-01 Ref ID:</label> <input type="text" id="adt01ReferenceId" />
        <label for="dateOfAdt01">ADT-01 Date:</label> <input type="date" id="dateOfAdt01" />
        <label for="adt02ReferenceId">ADT-02 Ref ID:</label> <input type="text" id="adt02ReferenceId" />
        <label for="dateOfAdt02">ADT-02 Date:</label> <input type="date" id="dateOfAdt02" />
      </div>
    </div>

    <div class="accordion-section">
      <button type="button" class="accordion-header">ASMT Details <span class="accordion-icon">+</span></button>
      <div class="accordion-content">
        <label for="asmt10">ASMT 10:</label> <input type="text" id="asmt10" />
        <label for="dateOfAsmt10">ASMT 10 Date:</label> <input type="date" id="dateOfAsmt10" />
      </div>
    </div>
    
    <div class="accordion-section">
        <button type="button" class="accordion-header">DRC Details <span class="accordion-icon">+</span></button>
        <div class="accordion-content">
            <label for="drc01AReferenceId">DRC-01A Ref ID:</label> <input type="text" id="drc01AReferenceId" />
            <label for="dateOfDrc01A">DRC-01A Date:</label> <input type="date" id="dateOfDrc01A" />
            <label for="drc01ReferenceId">DRC-01 Ref ID:</label> <input type="text" id="drc01ReferenceId" />
            <label for="dateOfDrc01">DRC-01 Date:</label> <input type="date" id="dateOfDrc01" />
        </div>
    </div>

    <div class="accordion-section">
        <button type="button" class="accordion-header">Reminder Details <span class="accordion-icon">+</span></button>
        <div class="accordion-content">
            <label for="reminderReferenceNo">Reminder Ref No.:</label> <input type="text" id="reminderReferenceNo" />
            <label for="reminderReferenceDate">Reminder Date:</label> <input type="date" id="reminderReferenceDate" />
        </div>
    </div>
    
    <div class="accordion-section">
        <button type="button" class="accordion-header">Reply Details <span class="accordion-icon">+</span></button>
        <div class="accordion-content">
            <label for="dueDateOfReply">Due Date of Reply:</label> <input type="date" id="dueDateOfReply" />
            <label for="dueReplyFiled">Reply Filed Date:</label> <input type="date" id="dueReplyFiled" /> 
        </div>
    </div>

    <div class="accordion-section">
        <button type="button" class="accordion-header">Order Details <span class="accordion-icon">+</span></button>
        <div class="accordion-content">
            <label for="orderReferenceId">Order Ref ID:</label> <input type="text" id="orderReferenceId" />
            <label for="dateOfOrder">Order Date:</label> <input type="date" id="dateOfOrder" />
        </div>
    </div>

    <div class="accordion-section">
        <button type="button" class="accordion-header">OIA Details <span class="accordion-icon">+</span></button>
        <div class="accordion-content">
            <label for="oiaReferenceId">OIA Ref ID:</label> <input type="text" id="oiaReferenceId" />
            <label for="dateOfOia">OIA Date:</label> <input type="date" id="dateOfOia" />
        </div>
    </div>

    <div class="accordion-section">
        <button type="button" class="accordion-header">Appeal Details <span class="accordion-icon">+</span></button>
        <div class="accordion-content">
            <label for="appealDueDate">Appeal Due Date:</label> <input type="date" id="appealDueDate" />
            <label for="appealFiledDate">Appeal Filed Date:</label> <input type="date" id="appealFiledDate" />
            <label for="apl02Arn">APL-02 ARN:</label> <input type="text" id="apl02Arn" />
            <label for="apl02Status">APL-02 Status:</label> <input type="text" id="apl02Status" />
            <label for="statusDate">Status Date (Appeal):</label> <input type="date" id="statusDate" /> 
            <label for="apl02Date">APL-02 Date:</label> <input type="date" id="apl02Date" />
        </div>
    </div>

    <div class="accordion-section">
        <button type="button" class="accordion-header">Financial Details <span class="accordion-icon">+</span></button>
        <div class="accordion-content">
            <label for="issues">Issues (Detailed):</label> <input type="text" id="issues" placeholder="Detailed issues"/>
            <label for="igst">IGST:</label> <input type="number" id="igst" step="0.01" placeholder="0.00"/>
            <label for="cgst">CGST:</label> <input type="number" id="cgst" step="0.01" placeholder="0.00"/>
            <label for="sgst">SGST:</label> <input type="number" id="sgst" step="0.01" placeholder="0.00"/>
            <label for="interest">Interest:</label> <input type="number" id="interest" step="0.01" placeholder="0.00"/>
            <label for="penalty">Penalty:</label> <input type="number" id="penalty" step="0.01" placeholder="0.00"/>
            <label for="totalDemand">Total Demand:</label> <input type="number" id="totalDemand" step="0.01" placeholder="0.00"/>
        </div>
    </div>

    <div class="accordion-section">
        <button type="button" class="accordion-header">Payment Details <span class="accordion-icon">+</span></button>
        <div class="accordion-content">
            <label for="paymentReferenceNumber">Payment Ref No.:</label> <input type="text" id="paymentReferenceNumber" />
            <label for="paymentDate">Payment Date:</label> <input type="date" id="paymentDate" />
            <label for="paymentAmount">Payment Amount:</label> <input type="number" id="paymentAmount" step="0.01" placeholder="0.00"/>
        </div>
    </div>

    <button type="submit">Save Changes</button>
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
    import { firebaseConfig } from './firebase_config.js'; 

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const params = new URLSearchParams(window.location.search);
    const caseIdFromUrl = params.get("id"); 

    const form = document.getElementById("editForm");
    const userEmailRoleDisplay = document.getElementById("user-email-role-display");
    const logoutButtonHeader = document.getElementById("logout-button-header");
    const primaryLeadNameDisplayInput = document.getElementById("primaryLeadNameDisplay");
    const assignedTeammatesSelect = document.getElementById("assignedTeammates");
    let currentUser = null;
    let currentCaseData = null; 

    // Accordion functionality
    const accordionHeaders = document.querySelectorAll(".accordion-header");
    accordionHeaders.forEach(header => {
        header.addEventListener("click", function() {
            this.classList.toggle("active");
            const content = this.nextElementSibling;
            const icon = this.querySelector(".accordion-icon");
            if (content.style.display === "block") {
                content.style.display = "none";
                icon.textContent = "+";
            } else {
                content.style.display = "block";
                icon.textContent = "−"; 
            }
        });
    });
    // By default, open the first accordion section (Client & Case Details)
    if (accordionHeaders.length > 0) {
        accordionHeaders[0].classList.add('active');
        accordionHeaders[0].nextElementSibling.style.display = 'block';
        accordionHeaders[0].querySelector('.accordion-icon').textContent = '−';
    }


    async function populateTeammateSelector(primaryLeadUidToExclude, currentlyAssignedUids = []) {
        if (!assignedTeammatesSelect) return;
        assignedTeammatesSelect.innerHTML = ''; 
        try {
            const usersSnapshot = await getDocs(collection(db, "userProfiles"));
            usersSnapshot.forEach(docSnap => {
                const userData = docSnap.data();
                const userUid = docSnap.id;
                if (userUid !== primaryLeadUidToExclude) {
                    const option = document.createElement('option');
                    option.value = userUid;
                    option.textContent = userData.displayName || userData.email;
                    if (currentlyAssignedUids.includes(userUid)) {
                        option.selected = true;
                    }
                    assignedTeammatesSelect.appendChild(option);
                }
            });
        } catch (error) {
            console.error("Error loading users for teammate selector:", error);
        }
    }

    onAuthStateChanged(auth, (firebaseUser) => {
        if (firebaseUser) {
            const storedUserJSON = localStorage.getItem('currentUser');
            if (storedUserJSON) {
                currentUser = JSON.parse(storedUserJSON);
                if (currentUser.uid === firebaseUser.uid) {
                    if (currentUser.role === 'viewer') {
                        alert("Viewers are not authorized to edit cases. Redirecting to dashboard.");
                        window.location.href = 'dashboard.html';
                        return;
                    }
                    const displayRole = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
                    if(userEmailRoleDisplay) userEmailRoleDisplay.textContent = `${currentUser.displayName || currentUser.email} (${displayRole})`;
                    loadCase(); 
                } else {
                    localStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                }
            } else {
                window.location.href = 'index.html';
            }
        } else {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
    });

    if(logoutButtonHeader) {
        logoutButtonHeader.addEventListener('click', () => {
            signOut(auth).then(() => {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }).catch((error) => console.error('Sign out error', error));
        });
    }

    function formatDateForInput(dateValue) {
      if (!dateValue) return "";
      try {
        let date;
        if (dateValue && typeof dateValue.toDate === 'function') { 
          date = dateValue.toDate();
        } else if (dateValue) {
          date = new Date(dateValue); 
        } else {
          return ""; 
        }
        if (isNaN(date.getTime())) {
            return ""; 
        }
        return date.toISOString().split("T")[0];
      } catch (error) {
        console.error("Error formatting date:", dateValue, error);
        return ""; 
      }
    }

    async function loadCase() {
      if (!caseIdFromUrl) {
        alert("No case ID provided in URL. Cannot load case data.");
        form.style.display = 'none';
        return;
      }
      const docRef = doc(db, "cases", caseIdFromUrl);
      try {
        const snapshot = await getDoc(docRef);
        if (snapshot.exists()) {
          currentCaseData = { id: snapshot.id, ...snapshot.data() }; 
          
          if (currentUser.role === 'caseLead' && !currentCaseData.assignedUsersUids?.includes(currentUser.uid)) {
              alert("You are not authorized to edit this case. Redirecting to dashboard.");
              window.location.href = 'dashboard.html';
              return;
          }

          form.querySelectorAll("input, select").forEach(inputElement => {
            const key = inputElement.id;
            if (inputElement.id === "primaryLeadNameDisplay") {
                inputElement.value = currentCaseData.primaryLeadName || currentCaseData.leadName || ''; 
                inputElement.readOnly = (currentUser.role === 'caseLead');
            } else if (inputElement.id === "assignedTeammates") {
                // Defer to populateTeammateSelector
            } else if (currentCaseData.hasOwnProperty(key)) {
              let dataValue = currentCaseData[key];
              if (key === 'dueOfReplyFiled' && currentCaseData.hasOwnProperty('dueReplyFiled')) { 
                  dataValue = currentCaseData.dueReplyFiled;
              }
              if (key === 'apl02StatusDate' && currentCaseData.hasOwnProperty('statusDate')) { 
                  dataValue = currentCaseData.statusDate;
              }

              if (inputElement.type === "date") {
                inputElement.value = formatDateForInput(dataValue);
              } else if (inputElement.type === "number") {
                inputElement.value = dataValue === null || dataValue === undefined || dataValue === "" ? "" : parseFloat(dataValue);
              } else if (inputElement.tagName === 'SELECT' && inputElement.id === 'status') {
                inputElement.value = dataValue || "Open"; 
              } else if (inputElement.tagName === 'SELECT' && inputElement.id === 'priority') {
                inputElement.value = dataValue || "Medium"; 
              }
              else {
                inputElement.value = dataValue === null || dataValue === undefined ? "" : dataValue;
              }
            }
          });
          const coLeadUids = currentCaseData.assignedUsersUids ? 
                             currentCaseData.assignedUsersUids.filter(uid => uid !== currentCaseData.primaryLeadUid) : [];
          await populateTeammateSelector(currentCaseData.primaryLeadUid, coLeadUids);

        } else {
          alert("Case not found with ID: " + caseIdFromUrl);
          form.style.display = 'none';
        }
      } catch (error) {
          console.error("Error loading case:", error);
          alert("Error loading case data. Check console for details.");
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!caseIdFromUrl || !currentCaseData) {
          alert("Cannot update: Case data not loaded or no case ID specified.");
          return;
      }
      if (currentUser.role === 'caseLead' && !currentCaseData.assignedUsersUids?.includes(currentUser.uid)) {
          alert("You are not authorized to save changes to this case.");
          return;
      }

      const docRef = doc(db, "cases", caseIdFromUrl);
      const updatedData = {};
      console.log("Starting to build updatedData. Current form values:"); 

      const inputs = form.querySelectorAll("input, select");
      inputs.forEach((input) => {
        console.log(`Processing input: id='${input.id}', type='${input.type}', tagName='${input.tagName}', value='${input.value}'`);
        if (input.id && input.id !== "primaryLeadNameDisplay" && input.id !== "assignedTeammates") { 
          let valueToStore;
          let rawValue = input.value;

          if (input.type === "number") {
            if (rawValue === "" || rawValue === null || typeof rawValue === 'undefined') { 
              valueToStore = null;
            } else {
              const num = parseFloat(rawValue);
              valueToStore = isNaN(num) ? null : num;
            }
          } else if (input.type === "date") {
            valueToStore = (rawValue === "" || rawValue === null || typeof rawValue === 'undefined') ? null : rawValue;
          } else if (input.tagName === 'SELECT') { 
            valueToStore = rawValue; 
          } else { 
            valueToStore = (typeof rawValue === 'undefined') ? null : rawValue;
          }
          
          let firestoreKey = input.id;
          if (input.id === 'dueOfReplyFiled') { 
              firestoreKey = 'dueReplyFiled'; 
          }
          if (input.id === 'statusDate' && currentCaseData.hasOwnProperty('apl02StatusDate')) { 
              firestoreKey = 'apl02StatusDate'; 
          }
          console.log(`  -> Determined firestoreKey: '${firestoreKey}', valueToStore:`, valueToStore, `(type: ${typeof valueToStore})`);

          if (typeof valueToStore === 'undefined') {
            console.warn(`  -> Value for '${firestoreKey}' was undefined. Converting to null.`);
            updatedData[firestoreKey] = null;
          } else {
            updatedData[firestoreKey] = valueToStore;
          }
        } else {
          console.log(`  -> Skipping input: id='${input.id}'`);
        }
      });
      
      const selectedCoLeadUids = Array.from(assignedTeammatesSelect.selectedOptions).map(option => option.value);
      
      if (typeof currentCaseData.primaryLeadUid !== 'undefined') {
        updatedData.primaryLeadUid = currentCaseData.primaryLeadUid;
      } else {
        updatedData.primaryLeadUid = null; 
        console.warn("'currentCaseData.primaryLeadUid' was undefined, setting to null in updatedData for 'primaryLeadUid' field.");
      }

      const tempAssignedUsersUids = [];
      if (updatedData.primaryLeadUid) { 
        tempAssignedUsersUids.push(updatedData.primaryLeadUid);
      }
      selectedCoLeadUids.forEach(uid => {
        if (uid && uid !== updatedData.primaryLeadUid) { 
          tempAssignedUsersUids.push(uid);
        }
      });
      updatedData.assignedUsersUids = [...new Set(tempAssignedUsersUids)];
      console.log("Assigned Teammates (assignedUsersUids):", updatedData.assignedUsersUids);
      
      updatedData.primaryLeadName = primaryLeadNameDisplayInput.value.trim(); 
      updatedData.leadName = primaryLeadNameDisplayInput.value.trim();
      updatedData.lastUpdatedAt = new Date();
      console.log("Primary Lead UID (in updatedData):", updatedData.primaryLeadUid);
      console.log("Primary Lead Name:", updatedData.primaryLeadName);
      console.log("Last Updated At:", updatedData.lastUpdatedAt);

      console.log("Final updatedData object to be sent to Firestore:", JSON.parse(JSON.stringify(updatedData, (key, value) =>
        typeof value === 'undefined' ? null : value 
      )));

      try {
        await updateDoc(docRef, updatedData);
        alert("Case updated successfully!");
        window.location.href = "dashboard.html"; 
      } catch (error) {
        console.error("Error updating document:", error); 
        alert("Failed to update case. Check console for details.");
      }
    });
  </script>
</body>
</html>
